---
import { getLocaleUrlCTM, supportedLanguages } from "@/lib/utils/i18nUtils";
import { plainify, removeWhitespace, truncateTitle, truncateMetaDescription } from "@/lib/utils/textConverter";
import config from ".astro/config.generated.json" with { type: "json" };
import { hasAlternateLangPost, hasAlternateLangService } from "@/lib/contentParser.astro";

// Load the configuration
let {
  title,
  metaTitle,
  description,
  metaDescription,
  canonical,
  keywords = config.seo.keywords,
  disableTagline,
  author = config.seo.author,
  robots = config.seo.robots,
} = Astro.props;

title = plainify(metaTitle ? metaTitle : title ? title : config.site.title);
keywords = keywords.join(", ");

// Add tagline & separator to title
if (!disableTagline) {
  title =
    title +
    (config.site.tagline &&
      (config.site.taglineSeparator || " - ") + config.site.tagline);
}

// Increase truncation limit to 100 to accommodate longer titles
title = truncateTitle(title, 100);

description = plainify(
  metaDescription
    ? metaDescription
    : description
      ? description
      : config.site.description,
);

// Increase truncation limit to 300 to accommodate longer descriptions
description = truncateMetaDescription(description, 300);

// Generate canonical URL using the current page's actual URL
// Use pathname to ensure we get the correct URL format (Astro routes are case-insensitive)
const currentUrl = new URL(Astro.url.pathname, Astro.site);
canonical = getLocaleUrlCTM(
  currentUrl.href,
  Astro.currentLocale,
);

const alternateTags: Array<{ hreflang: string; href: string }> = [];
// If multilingual is enabled, add rel alternate link tags
if (
  config.settings.multilingual.enable &&
  !canonical.includes("blog/category/")
) {
  // Normalize the current URL to use the configured base URL (Astro.site)
  // Use pathname to ensure consistent URL format
  // This ensures hreflang URLs always use the correct domain and format
  const normalizedUrl = new URL(Astro.url.pathname, Astro.site).href;
  
  // 检查是否是 blog 文章页面或服务页面（在文件顶部声明，避免重复声明）
  const isBlogPost = Astro.url.pathname.includes(`/${config.settings.blogFolder}/`) && 
                     !Astro.url.pathname.includes("/category/") &&
                     !Astro.url.pathname.endsWith(`/${config.settings.blogFolder}/`);
  const isServicePage = Astro.url.pathname.includes(`/${config.settings.servicesFolder}/`) && 
                       !Astro.url.pathname.endsWith(`/${config.settings.servicesFolder}/`) &&
                       !Astro.url.pathname.endsWith(`/${config.settings.servicesFolder}`);
  
  if (isBlogPost && Astro.props.post?.id) {
    // 对于 blog 文章，只添加有对应语言版本的 hreflang
    const postId = Astro.props.post.id;
    
    for (const lang of supportedLanguages) {
      // 当前语言总是添加
      if (lang.languageCode === Astro.currentLocale) {
        alternateTags.push({
          hreflang: lang.languageCode,
          href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
        });
      } else {
        // 检查是否有对应语言版本
        const hasAlternate = await hasAlternateLangPost(
          "blog",
          postId,
          Astro.currentLocale,
        );
        if (hasAlternate) {
          alternateTags.push({
            hreflang: lang.languageCode,
            href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
          });
        }
      }
    }
  } else {
    // 检查是否是服务页面（使用已声明的变量）
    if (isServicePage && Astro.props.service?.id) {
      // 对于服务页面，只添加有对应语言版本的 hreflang
      const serviceId = Astro.props.service.id;
      
      for (const lang of supportedLanguages) {
        // 当前语言总是添加
        if (lang.languageCode === Astro.currentLocale) {
          alternateTags.push({
            hreflang: lang.languageCode,
            href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
          });
        } else {
          // 检查是否有对应语言版本
          const hasAlternate = await hasAlternateLangService(
            "services",
            serviceId,
            Astro.currentLocale,
          );
          if (hasAlternate) {
            alternateTags.push({
              hreflang: lang.languageCode,
              href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
            });
          }
        }
      }
    } else {
      // 其他页面，使用原来的逻辑（为所有语言添加）
      supportedLanguages.forEach((lang) => {
        alternateTags.push({
          hreflang: lang.languageCode,
          href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
        });
      });
    }
  }
  
  // Add x-default tag pointing to the default language version
  // This helps search engines understand which version to show to users
  // whose language preference doesn't match any of the available languages
  // For blog posts and service pages, only add x-default if the default language version exists
  // (使用已声明的 isBlogPost 和 isServicePage 变量)
  let shouldAddXDefault = true;
  
  if (isBlogPost && Astro.props.post?.id) {
    // For blog posts, check if default language version exists
    const defaultLang = config.settings.multilingual.defaultLanguage;
    if (defaultLang !== Astro.currentLocale) {
      const hasDefaultLang = await hasAlternateLangPost(
        "blog",
        Astro.props.post.id,
        Astro.currentLocale,
      );
      shouldAddXDefault = hasDefaultLang || defaultLang === Astro.currentLocale;
    }
  } else if (isServicePage && Astro.props.service?.id) {
    // For service pages, check if default language version exists
    const defaultLang = config.settings.multilingual.defaultLanguage;
    if (defaultLang !== Astro.currentLocale) {
      const hasDefaultLang = await hasAlternateLangService(
        "services",
        Astro.props.service.id,
        Astro.currentLocale,
      );
      shouldAddXDefault = hasDefaultLang || defaultLang === Astro.currentLocale;
    }
  }
  
  if (shouldAddXDefault) {
    const defaultLangUrl = getLocaleUrlCTM(
      normalizedUrl,
      config.settings.multilingual.defaultLanguage,
    );
    alternateTags.push({
      hreflang: "x-default",
      href: defaultLangUrl,
    });
  }
}
---

{title && <title>{removeWhitespace(title)}</title>}
{
  description && (
    <meta name="description" content={removeWhitespace(description)} />
  )
}
{keywords && <meta name="keywords" content={removeWhitespace(keywords)} />}
{author && <meta name="author" content={removeWhitespace(author)} />}
{robots && <meta name="robots" content={removeWhitespace(robots)} />}
{canonical && <link rel="canonical" href={canonical} item-prop="url" />}
{
  alternateTags &&
    alternateTags.map((tag) => (
      <link rel="alternate" hreflang={tag.hreflang} href={tag.href} />
    ))
}
