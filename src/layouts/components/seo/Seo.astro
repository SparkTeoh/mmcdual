---
import { getLocaleUrlCTM, supportedLanguages } from "@/lib/utils/i18nUtils";
import { plainify, removeWhitespace } from "@/lib/utils/textConverter";
import config from ".astro/config.generated.json" with { type: "json" };
import { hasAlternateLangPost } from "@/lib/contentParser.astro";

// Load the configuration
let {
  title,
  metaTitle,
  description,
  metaDescription,
  canonical,
  keywords = config.seo.keywords,
  disableTagline,
  author = config.seo.author,
  robots = config.seo.robots,
} = Astro.props;

title = plainify(metaTitle ? metaTitle : title ? title : config.site.title);
keywords = keywords.join(", ");

// Add tagline & separator to title
if (!disableTagline) {
  title =
    title +
    (config.site.tagline &&
      (config.site.taglineSeparator || " - ") + config.site.tagline);
}

description = plainify(
  metaDescription
    ? metaDescription
    : description
      ? description
      : config.site.description,
);

canonical = getLocaleUrlCTM(
  new URL(Astro.url.href, Astro.site).href,
  Astro.currentLocale,
);

const alternateTags: Array<{ hreflang: string; href: string }> = [];
// If multilingual is enabled, add rel alternate link tags
if (
  config.settings.multilingual.enable &&
  !canonical.includes("blog/category/")
) {
  // Normalize the current URL to use the configured base URL (Astro.site)
  // This ensures hreflang URLs always use the correct domain
  const normalizedUrl = new URL(Astro.url.href, Astro.site).href;
  
  // 检查是否是 blog 文章页面
  const isBlogPost = Astro.url.pathname.includes(`/${config.settings.blogFolder}/`) && 
                     !Astro.url.pathname.includes("/category/") &&
                     !Astro.url.pathname.endsWith(`/${config.settings.blogFolder}/`);
  
  if (isBlogPost && Astro.props.post?.id) {
    // 对于 blog 文章，只添加有对应语言版本的 hreflang
    const postId = Astro.props.post.id;
    
    for (const lang of supportedLanguages) {
      // 当前语言总是添加
      if (lang.languageCode === Astro.currentLocale) {
        alternateTags.push({
          hreflang: lang.languageCode,
          href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
        });
      } else {
        // 检查是否有对应语言版本
        const hasAlternate = await hasAlternateLangPost(
          "blog",
          postId,
          Astro.currentLocale,
        );
        if (hasAlternate) {
          alternateTags.push({
            hreflang: lang.languageCode,
            href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
          });
        }
      }
    }
  } else {
    // 非 blog 文章页面，使用原来的逻辑（为所有语言添加）
    supportedLanguages.forEach((lang) => {
      alternateTags.push({
        hreflang: lang.languageCode,
        href: getLocaleUrlCTM(normalizedUrl, lang.languageCode),
      });
    });
  }
  
  // Add x-default tag pointing to the default language version
  // This helps search engines understand which version to show to users
  // whose language preference doesn't match any of the available languages
  const defaultLangUrl = getLocaleUrlCTM(
    normalizedUrl,
    config.settings.multilingual.defaultLanguage,
  );
  alternateTags.push({
    hreflang: "x-default",
    href: defaultLangUrl,
  });
}
---

{title && <title>{removeWhitespace(title)}</title>}
{
  description && (
    <meta name="description" content={removeWhitespace(description)} />
  )
}
{keywords && <meta name="keywords" content={removeWhitespace(keywords)} />}
{author && <meta name="author" content={removeWhitespace(author)} />}
{robots && <meta name="robots" content={removeWhitespace(robots)} />}
{canonical && <link rel="canonical" href={canonical} item-prop="url" />}
{
  alternateTags &&
    alternateTags.map((tag) => (
      <link rel="alternate" hreflang={tag.hreflang} href={tag.href} />
    ))
}
