---
import { getLocaleUrlCTM } from "@/lib/utils/i18nUtils.ts";
import { humanize } from "@/lib/utils/textConverter";
import SchemaSnippet from "@/layouts/components/widgets/SchemaSnippet.astro";
import { buildBreadcrumbSchema } from "@/lib/utils/schema";

// Props
interface Props {
  class?: string;
  hiddenPaths?: string[];
}

const { hiddenPaths, class: className, ...rest } = Astro.props;

// Helper function to create breadcrumb parts
const createBreadcrumbParts = (pathname: string) => {
  let segments = pathname.split("/").filter((segment) => segment);

  // Remove locale from segments
  if (segments[0] === Astro.currentLocale) {
    segments = segments.slice(1);
  }

  const breadcrumbParts = [
    {
      label: "Home",
      href: getLocaleUrlCTM("/", Astro.currentLocale),
      "aria-label": pathname === "/" ? "page" : undefined,
    },
  ];

  segments.forEach((segment, index) => {
    const href = getLocaleUrlCTM(
      `/${segments.slice(0, index + 1).join("/")}`,
      Astro.currentLocale,
    );
    if (segment !== "page") {
      breadcrumbParts.push({
        label:
          humanize(segment.replace(".html", "").replace(/[-_]/g, " ")) || "",
        href,
        "aria-label": pathname === href ? "page" : undefined,
      });
    }
  });

  return breadcrumbParts;
};

// Generate breadcrumb parts
let breadcrumbParts = createBreadcrumbParts(Astro.url.pathname);

// Remove any breadcrumb parts whose label matches hiddenPaths
if (hiddenPaths && hiddenPaths.length > 0) {
  breadcrumbParts = breadcrumbParts.filter(
    (part) => !hiddenPaths.includes(String(part.label)),
  );
}

const siteUrl = Astro.site?.href ?? new URL("/", Astro.url).href;
const breadcrumbSchema = buildBreadcrumbSchema({
  locale: Astro.currentLocale,
  siteUrl,
  items: breadcrumbParts.map(({ label, href }) => ({
    label: typeof label === "string" ? label : String(label),
    href,
  })),
});
---

<nav aria-label="Breadcrumb" class:list={[className]} {...rest}>
  <ol
    class="has-list has-list-slash slash-dark inline-flex flex-wrap gap-y-3"
    role="list">
    {
      breadcrumbParts.map(({ label, ...attrs }, index) => (
        <li class="mx-1 capitalize" role="listitem">
          {index !== breadcrumbParts.length - 1 && attrs.href !== "" ? (
            <a class="text-primary" {...attrs}>
              {label}
            </a>
          ) : (
            <span class="text-text-default/70" set:html={label} />
          )}
        </li>
      ))
    }
  </ol>
</nav>
<SchemaSnippet data={breadcrumbSchema} />
