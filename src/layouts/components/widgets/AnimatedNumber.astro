---
import { markdownify } from "@/lib/utils/textConverter";
import "@/plugins/odometer/odometer.min.css";

interface Props {
  class?: string;
  animateOn?: "click" | undefined;
  transitionTime?: string;
  childClass?: string;
  enable?: boolean;
  content: {
    value?: string | number;
    type?: string; // pricing tye (applicable for pricing page)
    prependValue?: string;
    appendValue?: string;
  };
}

const {
  enable = true,
  animateOn,
  transitionTime,
  class: className,
  childClass: childClassName,
  content,
} = Astro.props;

// Check number char length and give that number of zero
const addZero = (content: string) => {
  return "0".repeat(Number(content.length));
};

// Check if value is numeric (including numbers with decimals, percentages, etc.)
const isNumeric = (value: string | number | undefined): boolean => {
  if (value === undefined || value === null) return false;
  const str = String(value).trim();
  // Check if it's a pure number or number with suffix like "100%", "3x", etc.
  // But exclude text values like "Zero", "IPO", "Maximized", etc.
  if (str === "" || str === "Zero" || str === "零" || str === "IPO" || str === "Maximized" || str === "Maximise" || str === "最大化" || str === "One" || str === "一") {
    return false;
  }
  // Check if it starts with a digit or can be parsed as a number
  return /^[\d.+-]/.test(str) || !isNaN(Number(str));
};
---

<div
  class:list={[
    "inline-flex place-items-stretch leading-none",
    { "has-animated-number": enable },
    className,
  ]}>
  {
    content.prependValue && (
      <span
        class:list={["prepend", childClassName]}
        set:html={markdownify(content.prependValue)}
      />
    )
  }

  <span
    {...{
      "data-count": content.value || undefined,
      "data-type": content.type && content.type.toLowerCase(),
      style: { "--odometer-duration": transitionTime },
    }}
    class:list={[
      { 
        odometer: enable && isNumeric(content.value),
        "non-numeric": enable && !isNumeric(content.value)
      }, 
      childClassName
    ]}
    set:html={enable && content.value && animateOn !== "click" && isNumeric(content.value)
      ? addZero(content.value as string)
      : content.value}
  />

  {
    content.appendValue && (
      <span
        class:list={["append", childClassName]}
        set:html={markdownify(content.appendValue)}
      />
    )
  }
</div>
<script>
  import "@/plugins/odometer/odometer.min.js";

  import { inView } from "motion";

  window.addEventListener("load", () => {
    function animateNumbers(
      containerSelector = ".has-animated-number",
      numberSelector = ".odometer",
    ) {
      const containers = document.querySelectorAll(containerSelector);

      containers.forEach((container) => {
        // @ts-expect-error
        inView(container, (elem) => {
          const numbers = elem.querySelectorAll(numberSelector);

          numbers.forEach((numEl) => {
            const countNumber = numEl.getAttribute("data-count");
            
            // For non-numeric values (like "Zero", "IPO", "Maximized"), set textContent directly
            // For numeric values, let odometer handle it
            if (countNumber) {
              const isNonNumeric = countNumber === "Zero" || 
                                   countNumber === "零" ||
                                   countNumber === "IPO" || 
                                   countNumber === "Maximized" || 
                                   countNumber === "Maximise" || 
                                   countNumber === "最大化" ||
                                   countNumber === "One" ||
                                   countNumber === "一" ||
                                   (!/^[\d.+-]/.test(countNumber) && isNaN(Number(countNumber)));
              
              if (isNonNumeric) {
                // For non-numeric values, directly set textContent
                numEl.textContent = countNumber;
              } else {
                // For numeric values, odometer will handle it
                numEl.textContent = countNumber;
              }
            }
          });

          // Run once only (like ScrollTrigger once:true)
          return false;
        });
      });
    }

    animateNumbers();
  });
</script>
