---
import Icons from "@/helpers/Icons.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { getTaxonomy } from "@/lib/taxonomyParser.astro";
import {
  getLocaleUrlCTM,
  useTranslations,
} from "@/lib/utils/i18nUtils.ts";

interface Category {
  name: string;
  slug: string;
  count: number;
}

interface Props {
  class?: string;
}

const posts = await getCollectionCTM(
  config.settings.blogFolder as "blog",
  Astro.currentLocale,
);

let categories = (await getTaxonomy(
  config.settings.blogFolder as "blog",
  "categories",
  Astro.currentLocale as string,
)) as Category[];

categories = categories.map((category) => {
  const count = posts.filter((post) =>
    post.data.categories.includes(category.name),
  ).length;

  const slug = getLocaleUrlCTM(
    category.slug,
    Astro.currentLocale,
    `/${config.settings.blogFolder}/category`,
  );

  return {
    ...category,
    count,
    slug,
  };
});

const t = await useTranslations(Astro.currentLocale as string);
const allLabel = t("widgets.categoriesAll") || "All";

const allUrl = getLocaleUrlCTM(
  `/${config.settings.blogFolder}/`,
  Astro.currentLocale as string,
);

// Sort categories by count
categories = categories.sort((a, b) => b.count - a.count);
---

{
  categories && categories.length > 0 && (
    <div class="flex flex-wrap items-center justify-center gap-4 md:gap-8">
      <a
        href={allUrl}
        class={`text-sm font-medium transition duration-300 hover:text-primary ${
          Astro.url.pathname === allUrl ||
          Astro.url.pathname === allUrl.replace(/\/$/, "")
            ? "text-primary border border-primary px-3 py-1 rounded"
            : "text-text-default"
        }`}
      >
        {allLabel}
      </a>
      {categories.map((category) => (
        <a
          href={category.slug}
          class={`text-sm font-medium transition duration-300 hover:text-primary ${
            Astro.url.pathname.includes(category.slug)
              ? "text-primary"
              : "text-text-default"
          }`}
        >
          {category.name}
        </a>
      ))}
    </div>
  )
}
