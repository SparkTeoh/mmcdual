---
import Icons from "@/helpers/Icons.astro";
import { sortByDate } from "@/lib/utils/sortFunctions";
import { slugifyyy } from "@/lib/utils/textConverter";
import { getEntryCTM } from "@/lib/contentParser.astro";
import bgOptimizedImage from "@/lib/utils/bgOptimizedImage";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { generateCategorySlugs } from "@/lib/taxonomyParser.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { getLocaleUrlCTM, useTranslations } from "@/lib/utils/i18nUtils.ts";

interface Props {
  class?: string;
  blogCardLayout?: string;
}

const currentLocale = Astro.currentLocale;

const blogFolder = config.settings.blogFolder as "blog";
const postIndex = await getEntryCTM(
  blogFolder as "blog",
  "-index",
  currentLocale,
);

const blogCardLayout =
  Astro.props.blogCardLayout ||
  postIndex?.data.settings?.card?.layout ||
  "classic";

let posts = await getCollectionCTM(blogFolder as "blog", currentLocale);
posts = await processPosts(posts);

const postJson = sortByDate(posts).map((item) => {
  return {
    title: item.data.title,
    slug: getLocaleUrlCTM(item.id, currentLocale, blogFolder),
    date: item.data.date,
    author: item.data.author,
    authorImage: item.data.authorImage,
    image: item.data.image,
    description: item.data.description,
    categories: generateCategorySlugs(
      item.data.categories,
      currentLocale as string,
      blogFolder,
    ),
  };
});

async function processPosts(sortedPosts: any) {
  sortedPosts = await Promise.all(
    sortedPosts.map(async (post: any) => {
      const authorEntry = await getEntryCTM(
        "author",
        slugifyyy(post.data.author || ""),
        currentLocale,
      );

      return {
        ...post,
        data: {
          ...post.data,
          image: await bgOptimizedImage(post.data.image),
          author: authorEntry?.data.title,
          authorImage: await bgOptimizedImage(authorEntry?.data.image),
        },
      };
    }),
  );

  return sortedPosts;
}

const baseURL = Astro.url.origin;
const t = await useTranslations(Astro.currentLocale as string);
const learnMoreI18n = t("common.learnMoreAbout");
const btnLabelReadMoreI18n = t("common.readMore");

const notFoundImage = await bgOptimizedImage("/images/404.svg");
---

<div class="w-full">
  <form method="post" class="relative w-full" id="search">
    <div class="relative flex items-center">
      <span class="absolute left-4 text-gray-400">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
      </span>
      <input
        type="search"
        placeholder="Type & hit Enter ..."
        class="w-full rounded-full bg-[#333333] py-4 pl-12 pr-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary border-none"
      />
    </div>
  </form>
</div>

<script
  is:inline
  define:vars={{
    baseURL,
    notFoundImage,
    postJson,
    blogFolder,
    blogCardLayout,
    learnMoreI18n,
    btnLabelReadMoreI18n,
    trailingSlash: config.site.trailingSlash,
  }}
>
  const shouldHaveTrailingSlash = trailingSlash;

  const trailingSlashCheckerInline = (url) => {
    // Separate the URL path from the fragment (if any)
    const [urlPath, fragment] = url.split("#");

    // Determine if we need to add or remove a trailing slash
    const hasTrailingSlash = urlPath.endsWith("/");

    // Adjust the URL path based on the trailing slash rule
    const adjustedPath = shouldHaveTrailingSlash
      ? hasTrailingSlash
        ? urlPath
        : `${urlPath}/`
      : hasTrailingSlash
        ? urlPath.slice(0, -1)
        : urlPath;

    // Reattach the fragment if it exists
    const fullURL = fragment ? `${adjustedPath}#${fragment}` : adjustedPath;

    return fullURL;
  };

  const posts = postJson;
  let searchResults = document.querySelector(".blog-search-results");

  let prevResults;
  setTimeout(() => {
    prevResults = document.querySelector(".blog-search-results").innerHTML;
  }, 200);

  document.querySelector("#search").addEventListener("submit", (e) => {
    e.preventDefault();
    const searchTerm = e.target[0].value;

    const pagination = document.querySelector("#pagination");
    searchResults = document.querySelector(".blog-search-results");

    const filteredPosts = posts.filter((post) => {
      return post.title.toLowerCase().includes(searchTerm.toLowerCase());
    });

    if (searchTerm === "") {
      searchResults.innerHTML = prevResults;

      // Hide or show pagination based on filter
      pagination?.classList.remove("hidden");
    } else {
      pagination?.classList.add("hidden");

      // If no posts found, display 404 image with text
      if (filteredPosts.length === 0) {
        // HTML template For Not found
        const notFoundHTML = `
            <div class="text-center space-y-10 w-full col-span-2">
              <img class="w-96 mx-auto" src=${notFoundImage} alt="404 Page Not Found - MMC Financial Planning blog search results" />
              <p class="text-h6">
                No Posts Found For <span class="text-primary">"${searchTerm}"</span>
              </p>
            </div>
            `;
        searchResults.innerHTML = notFoundHTML;

        return;
      }

      searchResults.innerHTML = "";
      filteredPosts.forEach((post) => {
        renderBlogPost(post, blogCardLayout);
      });
    }
  });

  // Function to render a blog post
  function renderBlogPost(post, layout) {
    // Function to format a date in "17 Jun, 2222" format
    const dateFormat = (date, pattern = "dd MMM, yyyy") => {
      const dateObj = new Date(date);

      if (pattern === "dd MMM, yyyy") {
        const formatter = new Intl.DateTimeFormat("en-US", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
        return formatter.format(dateObj);
      }

      throw new Error(`Unsupported pattern: ${pattern}`);
    };

    // HTML template For Blog Classic
    const blogClassicHTML = `
      <article class="bg-white">
        <div class="group after:from-primary after:via-primary/40 relative flex items-center justify-center overflow-hidden via-20% to-transparent after:pointer-events-none after:absolute after:inset-0 after:z-10 after:bg-linear-to-t after:transition-opacity after:duration-500 after:md:opacity-0 hover:md:after:opacity-100">
          <span class="bg-primary pointer-events-none absolute z-20 flex h-16 w-16 items-center justify-center rounded-full text-white transition duration-500 md:opacity-0 group-hover:md:opacity-100">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="ArrowUpRight" class="h-6 w-6 text-white">
              <path d="M7 7h10v10"></path>
              <path d="M7 17 17 7"></path>
            </svg>
          </span>
          <img src="${post.image}" alt="${post.imageAlt || post.title || 'MMC Financial Planning blog post'}" loading="lazy" class="h-62.5! min-w-full object-cover transition duration-500 group-hover:scale-105">
          <a class="absolute inset-0 z-30" href="${post.slug}" title="${learnMoreI18n} ${post.title}"></a>
        </div>
        <div>
          <div class="font-primary mt-6 mb-2 flex flex-wrap items-center gap-x-2.5 gap-y-px border-b pb-3 text-sm">
            <span>${dateFormat(post.date)}</span>
            <span class="bg-primary inline-block h-0.75 w-0.75 rounded-full"></span>
            ${post.categories
              .map(
                (category, index) => `
                  <span class="text-inherit">${category.name}</span>
                  ${index !== post.categories.length - 1 ? `<span class="bg-primary inline-block h-0.75 w-0.75 rounded-full"></span>` : ""}
                `,
              )
              .join("")}
          </div>
          <h2 class="text-h5 mt-2 mb-4">${post.title}</h2>
          <a href="${post.slug}" class="btn-wrapper has-icon-moving-animation text-base-sm capitalize md:text-base">
            <div class="btn btn-text has-icon-moving-animation no-underline text-flip-hover-anim">
              ${btnLabelReadMoreI18n}
              <span class="sr-only">${post.title}</span>
              <span class="icons-wrapper ms-1 -mb-px inline-flex min-h-[.9em] min-w-[1em] items-center justify-center">
                <span class="icon icon-before flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="ArrowUpRight" class="[font-size:inherit]">
                    <path d="M7 7h10v10"></path>
                    <path d="M7 17 17 7"></path>
                  </svg>
                </span>
                <span class="icon icon-after flex items-center justify-center" aria-hidden="true">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="ArrowUpRight" class="[font-size:inherit]">
                    <path d="M7 7h10v10"></path>
                    <path d="M7 17 17 7"></path>
                  </svg>
                </span>
              </span>
            </div>
          </a>
        </div>
      </article>
    `;

    // HTML template For Blog Modern
    const blogModernHTML = `
      <article class="relative pb-[4%] mb-[4%] pt-36 md:pt-72">
        <img
          src="${post.image}"
          class="w-full h-full object-cover absolute top-0 left-0"
          alt="${post.imageAlt || post.title || 'MMC Financial Planning blog post'}"
          loading="lazy"
          decoding="async"
        />
        <div class="mx-[4%] p-4 sm:p-8 box-shadow-primary relative z-10 bg-white/95">
          <div class="mb-2 text-sm flex items-center flex-wrap gap-y-px gap-x-2.5 text-primary">
            <span>${dateFormat(post.date)}</span>
            <span class="inline-block w-[0.1875rem] h-[0.1875rem] bg-primary rounded-full"></span>
            ${post.categories
              .map(
                (category, index) => `
                <a href="${category.slug}" class="text-inherit">${category.name}</a>
                ${index !== post.categories.length - 1 ? `<span class="inline-block w-[0.1875rem] h-[0.1875rem] bg-primary rounded-full"></span>` : ""}
              `,
              )
              .join("")}
          </div>
          <h2 class="text-h4 md:text-h5 mb-5">
            <a class="stretched-link text-inherit" href="${post.slug}">${post.title}</a>
          </h2>
          <div class="flex flex-wrap-reverse justify-between gap-x-8 gap-y-6">
            <div class="flex gap-4 items-center">
              <img
                src="${post.authorImage || ""}"
                data-image-component="true"
                class="w-10 h-10 border-2 border-dark/15 rounded-full"
                alt="${post.author ? post.author + ' - MMC Financial Planning author' : 'MMC Financial Planning team member and author'}"
                loading="lazy"
                decoding="async"
                width="160"
                height="160"
              />
              <span>By ${post.author || "Allium Johnson"}</span>
            </div>
            <ul class="flex items-center flex-wrap gap-4 opacity-70">
              <li>
                <a
                  aria-label="facebook"
                  href="https://www.facebook.com/sharer/sharer.php?u=${trailingSlashCheckerInline(baseURL + post.slug)}"
                  target="_blank"
                  rel="noopener noreferrer nofollow"
                  class="relative flex items-center justify-center transition duration-300 group bg-primary/5 text-dark hover:scale-110"
                >
                  <span class="sr-only">facebook</span>
                  <svg viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg" class="has-inherited-colors relative z-10 transition duration-300 w-4 h-4">
                    <g clip-path="url(#clip0_1299_11302)">
                      <rect width="25" height="25" fill="url(#paint0_linear_1299_11302)" fill-opacity="0.02"></rect>
                      <path fill-rule="evenodd" clip-rule="evenodd" d="M0.5 12.567C0.5 18.533 4.833 23.494 10.5 24.5V15.833H7.5V12.5H10.5V9.833C10.5 6.833 12.433 5.167 15.167 5.167C16.033 5.167 16.967 5.3 17.833 5.433V8.5H16.3C14.833 8.5 14.5 9.233 14.5 10.167V12.5H17.7L17.167 15.833H14.5V24.5C20.167 23.494 24.5 18.534 24.5 12.567C24.5 5.93 19.1 0.5 12.5 0.5C5.9 0.5 0.5 5.93 0.5 12.567Z" fill="#F9FBFF"></path>
                    </g>
                    <defs>
                      <linearGradient id="paint0_linear_1299_11302" x1="12.5" y1="0" x2="12.5" y2="25" gradientUnits="userSpaceOnUse">
                        <stop stop-color="white"></stop>
                        <stop offset="1" stop-color="white" stop-opacity="0"></stop>
                      </linearGradient>
                      <clipPath id="clip0_1299_11302">
                        <rect width="25" height="25" fill="white"></rect>
                      </clipPath>
                    </defs>
                  </svg>
                </a>
              </li>
              <li>
                <a
                  aria-label="twitter"
                  href="https://twitter.com/intent/tweet/?text=${post.title}&url=${trailingSlashCheckerInline(baseURL + post.slug)}"
                  target="_blank"
                  rel="noopener noreferrer nofollow"
                  class="relative flex items-center justify-center transition duration-300 group bg-primary/5 text-dark hover:scale-110"
                >
                  <span class="sr-only">twitter</span>
                  <svg viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg" class="has-inherited-colors relative z-10 transition duration-300 w-4 h-4">
                    <g>
                      <path d="M19.6875 1.17188H23.5214L15.1464 10.7683L25 23.829H17.2857L11.2393 15.9094L4.32857 23.829H0.491071L9.44821 13.5612L0 1.17366H7.91071L13.3679 8.41116L19.6875 1.17188ZM18.3393 21.529H20.4643L6.75 3.35223H4.47143L18.3393 21.529Z" fill="#fff"></path>
                    </g>
                  </svg>
                </a>
              </li>
              <li>
                <a
                  aria-label="linkedin"
                  href="https://www.linkedin.com/shareArticle?mini=true&url=${trailingSlashCheckerInline(baseURL + post.slug)}&title=${post.title}&summary=&source=${baseURL}"
                  target="_blank"
                  rel="noopener noreferrer nofollow"
                  class="relative flex items-center justify-center transition duration-300 group bg-primary/5 text-dark hover:scale-110"
                >
                  <span class="sr-only">linkedin</span>
                  <svg viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg" class="has-inherited-colors relative z-10 transition duration-300 w-4 h-4">
                    <rect width="25" height="25" fill="url(#paint0_linear_1299_11300)" fill-opacity="0.02"></rect>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 3.338C1.5 2.85053 1.69365 2.38303 2.03834 2.03834C2.38303 1.69365 2.85053 1.5 3.338 1.5H21.66C21.9016 1.49961 22.1409 1.54687 22.3641 1.63907C22.5874 1.73127 22.7903 1.86661 22.9612 2.03734C23.1322 2.20807 23.2677 2.41083 23.3602 2.63401C23.4526 2.8572 23.5001 3.09643 23.5 3.338V21.66C23.5003 21.9016 23.4529 22.1409 23.3606 22.3642C23.2683 22.5875 23.1328 22.7904 22.962 22.9613C22.7912 23.1322 22.5884 23.2678 22.3651 23.3602C22.1419 23.4526 21.9026 23.5001 21.661 23.5H3.338C3.09655 23.5 2.85746 23.4524 2.6344 23.36C2.41134 23.2676 2.20867 23.1321 2.03798 22.9613C1.8673 22.7905 1.73193 22.5878 1.63962 22.3647C1.54731 22.1416 1.49987 21.9025 1.5 21.661V3.338ZM10.208 9.888H13.187V11.384C13.617 10.524 14.717 9.75 16.37 9.75C19.539 9.75 20.29 11.463 20.29 14.606V20.428H17.083V15.322C17.083 13.532 16.653 12.522 15.561 12.522C14.046 12.522 13.416 13.611 13.416 15.322V20.428H10.208V9.888ZM4.708 20.291H7.916V9.75H4.708V20.29V20.291ZM8.375 6.312C8.38105 6.58667 8.33217 6.85979 8.23124 7.11532C8.13031 7.37084 7.97935 7.60364 7.78723 7.80003C7.59511 7.99643 7.3657 8.15248 7.11246 8.25901C6.85921 8.36554 6.58724 8.42042 6.3125 8.42042C6.03776 8.42042 5.76579 8.36554 5.51255 8.25901C5.2593 8.15248 5.02989 7.99643 4.83777 7.80003C4.64565 7.60364 4.49469 7.37084 4.39376 7.11532C4.29283 6.85979 4.24395 6.58667 4.25 6.312C4.26187 5.77286 4.48439 5.25979 4.86989 4.88269C5.25539 4.50558 5.77322 4.29442 6.3125 4.29442C6.85178 4.29442 7.36961 4.50558 7.75512 4.88269C8.14062 5.25979 8.36313 5.77286 8.375 6.312V6.312Z" fill="#F9FBFF"></path>
                    <defs>
                    <linearGradient id="paint0_linear_1299_11300" x1="12.5" y1="0" x2="12.5" y2="25" gradientUnits="userSpaceOnUse">
                    <stop stop-color="white"></stop>
                    <stop offset="1" stop-color="white" stop-opacity="0"></stop>
                    </linearGradient>
                    </defs>
                  </svg>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </article>
    `;

    // Append to the blog container
    const container = searchResults;
    container.innerHTML +=
      layout === "modern" ? blogModernHTML : blogClassicHTML;
  }
</script>
