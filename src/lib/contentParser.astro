---
import config from ".astro/config.generated.json" assert { type: "json" };
import languages from "@/config/language.json";
import {
  getCollection,
  type CollectionEntry,
  type CollectionKey,
} from "astro:content";

export const getCollectionCTM = async <C extends CollectionKey>(
  collectionName: C,
  lang: string | undefined,
): Promise<CollectionEntry<C>[]> => {
  const { defaultLanguage } = config.settings.multilingual;

  const selectedLanguageCode = lang || defaultLanguage;

  const language = languages.find(
    (l: any) => l.languageCode == selectedLanguageCode,
  );

  if (!language) {
    throw new Error("Language not found");
  }

  const { contentDir } = language;

  const pages: CollectionEntry<C>[] = (await getCollection(
    collectionName as any,
    (item: any) => {
      return item.id.startsWith(contentDir) && !item.id.endsWith("-index.md");
    },
  )) as CollectionEntry<C>[];

  // Prevent generation of pages with `draft: true` in production
  if (import.meta.env.PROD) {
    return pages.filter((page) => !page.data.draft);
  }

  return pages;
};

export const getEntryCTM = async <C extends CollectionKey>(
  collectionName: C,
  subCollectionName: string,
  lang?: string, // Optional, defaults to undefined
): Promise<CollectionEntry<C>> => {
  const { defaultLanguage } = config.settings.multilingual;

  const selectedLanguageCode = lang || defaultLanguage;

  const language = languages.find(
    (l: any) => l.languageCode === selectedLanguageCode,
  );

  if (!language) {
    throw new Error(`Language '${selectedLanguageCode}' not found.`);
  }

  const contentDir = language.contentDir;
  const path = subCollectionName
    ? `${contentDir}/${subCollectionName}`
    : contentDir;

  const entries = await getCollection(collectionName, ({ id }: any) => {
    // Remove extension like .md or .mdx
    const extensionExcluded = id.replace(/\.mdx?$/, "");

    return extensionExcluded === path;
  });

  return entries && (entries[0] as CollectionEntry<C>);
};

/**
 * 检查文章是否有另一种语言版本
 * @param collectionName 集合名称（如 "blog"）
 * @param currentPostId 当前文章的 ID（如 "english/post-13.mdx"）
 * @param currentLang 当前语言代码（如 "en" 或 "zh"）
 * @returns 如果存在另一种语言版本返回 true，否则返回 false
 */
export const hasAlternateLangPost = async <C extends CollectionKey>(
  collectionName: C,
  currentPostId: string,
  currentLang: string,
): Promise<boolean> => {
  // 获取另一种语言代码（en <-> zh）
  const alternateLang = currentLang === "en" ? "zh" : "en";
  
  // 提取文件名（如 post-13）
  const fileName = currentPostId
    .replace(/\.mdx?$/, "")
    .split("/")
    .pop();
  
  if (!fileName) {
    return false;
  }
  
  // 获取另一种语言的对应文章
  const alternatePosts = await getCollectionCTM(collectionName, alternateLang);
  const alternatePost = alternatePosts.find((post) => {
    const postFileName = post.id.replace(/\.mdx?$/, "").split("/").pop();
    return postFileName === fileName;
  });
  
  return alternatePost !== undefined;
};

/**
 * 检查服务页面是否有另一种语言版本
 * @param collectionName 集合名称（如 "services"）
 * @param currentServiceId 当前服务的 ID（如 "english/Incentive-Performance-Framework.md"）
 * @param currentLang 当前语言代码（如 "en" 或 "zh"）
 * @returns 如果存在另一种语言版本返回 true，否则返回 false
 */
export const hasAlternateLangService = async <C extends CollectionKey>(
  collectionName: C,
  currentServiceId: string,
  currentLang: string,
): Promise<boolean> => {
  // 获取另一种语言代码（en <-> zh）
  const alternateLang = currentLang === "en" ? "zh" : "en";
  
  // 提取文件名（如 Incentive-Performance-Framework）
  const fileName = currentServiceId
    .replace(/\.mdx?$/, "")
    .split("/")
    .pop();
  
  if (!fileName) {
    return false;
  }
  
  // 获取另一种语言的对应服务
  const alternateServices = await getCollectionCTM(collectionName, alternateLang);
  const alternateService = alternateServices.find((service) => {
    const serviceFileName = service.id.replace(/\.mdx?$/, "").split("/").pop();
    // 比较时使用小写，因为URL是大小写不敏感的
    return serviceFileName?.toLowerCase() === fileName.toLowerCase();
  });
  
  return alternateService !== undefined;
};
---
