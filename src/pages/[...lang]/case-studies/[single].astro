---
import "@/components/widgets/VideoModal.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import Base from "@/layouts/Base.astro";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import config from ".astro/config.generated.json" assert { type: "json" };
import PortfolioSingle from "@/components/PortfolioSingle.astro";

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { portfolioFolder } = config.settings;
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const portfolioIndex = await getEntryCTM(
        portfolioFolder as "case-studies",
        "-index",
        lang.languageCode,
      );

      let portfolios = await getCollectionCTM(
        portfolioFolder as "case-studies",
        lang.languageCode,
      );

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (portfolioIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return portfolios.map((portfolio) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            portfolio.data?.customSlug ||
            portfolio.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          portfolio,
        },
      }));
    }),
  );

  return paths.flat();
}

const { portfolio } = Astro.props;

// Get index file to check for default single layout
const portfolioIndex = await getEntryCTM(
  config.settings.portfolioFolder as "case-studies",
  "-index",
  Astro.currentLocale,
);

// Merge single layout: individual case study overrides index default
const singleLayout = portfolio.data.single?.layout || portfolioIndex?.data.single?.layout || "modern-sidebar";

// Create merged portfolio data with single layout
const mergedPortfolioData = {
  ...portfolio,
  data: {
    ...portfolio.data,
    single: {
      layout: singleLayout,
    },
  },
};
---

<Base {...portfolio.data}>
  <PortfolioSingle content={mergedPortfolioData} />
  <CallToAction />
</Base>
