---
import Base from "@/layouts/Base.astro";
import { slugifyyy } from "@/lib/utils/textConverter";
import { getEntryCTM } from "@/lib/contentParser.astro";
import { getTaxonomy } from "@/lib/taxonomyParser.astro";
import BlogListPage from "@/components/BlogListPage.astro";
import PageHeader from "@/components/widgets/PageHeader.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import CallToAction from "@/components/sections/CallToAction.astro";
import config from ".astro/config.generated.json" assert { type: "json" };

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const {
        blogFolder: blogFolder,
        multilingual: { defaultLanguage, showDefaultLangInUrl },
      } = config.settings;

      const postIndex = await getEntryCTM(
        blogFolder as "blog",
        "-index",
        lang.languageCode,
      );
      const categories = await getTaxonomy(
        blogFolder as "blog",
        "categories",
        lang.languageCode,
      );

      const paths = categories.map((category) => ({
        params: {
          // `category.slug` is already a URL-safe slug coming from
          // `getTaxonomy`. Re- slugifying it can return an empty string for
          // nonâ€‘Latin languages (e.g. Chinese), which breaks category routes.
          category: category.slug,
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
        },
        props: { category, postIndex, blogFolder },
      }));

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (postIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return paths;
    }),
  );

  return paths.flat();
}

const { category, postIndex } = Astro.props;

// Check if blog posts exist in the folder
let title = `${category.name} - ${postIndex?.data.title}`;
---

<Base {...postIndex?.data} title={title}>
  <PageHeader hiddenPaths={["Category"]} title={category.name} />
  <BlogListPage filterContent={category} pagination={{ enable: false }} />
  <CallToAction />
</Base>
