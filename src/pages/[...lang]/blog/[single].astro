---
import CallToAction from "@/components/sections/CallToAction.astro";
import Base from "@/layouts/Base.astro";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { getEntryCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import SinglePageLayout from "@/components/SinglePageLayout.astro";
import { buildArticleSchema } from "@/lib/utils/schema";

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const postIndex = await getEntryCTM("blog", "-index", lang.languageCode);
      let posts = await getCollectionCTM("blog", lang.languageCode);

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (postIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return posts.map((post) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            post.data?.customSlug ||
            post.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          post,
        },
      }));
    }),
  );

  return paths.flat();
}

const { post } = Astro.props;
const siteUrl = Astro.site?.href ?? new URL("/", Astro.url).href;
const heroImage = post.data.image
  ? new URL(post.data.image, siteUrl).href
  : undefined;
const publishedDate =
  typeof post.data.date === "string"
    ? post.data.date
    : post.data.date?.toISOString();
const articleSchema = buildArticleSchema({
  locale: Astro.currentLocale,
  article: {
    title: post.data.title,
    excerpt: post.data.excerpt ?? post.data.description,
    author: post.data.author,
    date: publishedDate,
    categories: post.data.categories,
  },
  url: Astro.url.href,
  image: heroImage,
  siteUrl,
});
---

<Base
  {...post.data}
  post={post}
  structuredData={{
    pageType: "Article",
    schemaNodes: [articleSchema],
  }}>
  <SinglePageLayout content={post} />
  <CallToAction />
</Base>
